---
- name: Deploy Minecraft Bedrock Server via Helm (auto-update)
  hosts: control_plane
  become: true

  vars:
    ansible_files_path: "~/source/ansible-files"

  vars_files:
    - "{{ ansible_files_path }}/vars/cluster_vars.yml"

  environment:
    K8S_AUTH_KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    PATH: "~/go/bin:{{ ansible_env.PATH }}"

  tasks:
    - name: Ensure minecraft-bedrock namespace exists
      k8s:
        api_version: v1
        kind: Namespace
        name: minecraft-bedrock
        state: present

    - name: Add itzg Helm repository
      kubernetes.core.helm_repository:
        name: itzg
        repo_url: "https://itzg.github.io/minecraft-server-charts/"

    - name: Deploy / upgrade Minecraft Bedrock (auto-update enabled)
      kubernetes.core.helm:
        name: minecraft-bedrock
        chart_ref: itzg/minecraft-bedrock
        release_namespace: minecraft-bedrock
        state: present

        values:
          persistence:
            dataDir:
              enabled: true
              storageClass: longhorn
              size: 100Gi

          resources:
            requests:
              memory: "12Gi"
              cpu: "3000m"

          # ---- MINECRAFT SERVER SETTINGS (TOP LEVEL) ----
          minecraftServer:
            eula: "TRUE"
            version: "LATEST"
            serverName: "Bedrock on K3s via Helm + Ansible"
            gamemode: survival
            difficulty: easy
            allowCheats: false
            onlineMode: true
            maxPlayers: 10
            viewDistance: 32
            levelName: "bedrock_world"

            # Service settings
            serverPort: 19132
            nodePort: 32619
            serviceType: NodePort

            # Only applies if you actually supply a URL
            downloadWorldUrl: "{{ minecraft_world_url | default('') }}"